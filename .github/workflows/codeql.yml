name: CodeQL
on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      has_py: ${{ steps.detect.outputs.has_py }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        name: Detect Python files
        shell: bash
        run: |
          if git ls-files "**/*.py" | grep -q .; then
            echo "has_py=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_py=false" >> "$GITHUB_OUTPUT"
          fi

  analyze:
    needs: precheck
    # Solo si hay .py y el repo es público (CodeQL gratis).
    if: ${{ needs.precheck.outputs.has_py == 'true' && github.repository_visibility == 'public' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: python
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  skip:
    needs: precheck
    # Para repos privados o sin .py: no hacer CodeQL y terminar en ✅
    if: ${{ needs.precheck.outputs.has_py != 'true' || github.repository_visibility != 'public' }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "Skipping CodeQL (has_py=${{needs.precheck.outputs.has_py}}, visibility=${{github.repository_visibility}})"
